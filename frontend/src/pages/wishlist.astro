---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Wishlist">
  <main>
    <div class="wrapper">
      <div class="heading-home-btn">
        <a href="/" class="home-link">
          <i class="fa-solid fa-angle-left"></i>
          Back to Dashboard
        </a>
        <h2>Wishlist</h2>
      </div>

      <div class="wishlist-list"></div>
    </div>
  </main>
</Layout>

<style is:global>
  main {
    background-color: #1f1e2e;
    padding: 1rem;
    display: flex;
    justify-content: center;
    align-items: start;
    flex: 1;
  }

  .wrapper {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding-bottom: 3rem;
    max-width: 1440px;
    width: 100%;
  }

  .heading-home-btn {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: start;
  }

  .home-link {
    align-self: flex-start;
    text-decoration: none;
    color: #a7969c;
  }

  .home-link:hover {
    text-decoration: underline;
  }

  .heading-home-btn h2 {
    font-family: "Orbitron", sans-serif;
    font-weight: 500;
    color: #ffffff;
  }

  .empty {
    color: #ffffff;
    align-self: center;
  }

  .wishlist-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .card {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    border-radius: 10px;
    border: 1px solid #3c3a4f;
    background-color: #2e2f44;
    transition: all 0.5s linear;
  }

  .card:hover {
    box-shadow: 0px 0px 20px 5px #3c3a4f;
    transform: scale(1.03);
    cursor: pointer;
  }

  .game-img {
    width: 150px;
  }

  .game-img img {
    width: 100%;
    object-fit: cover;
    object-position: center;
    border-radius: 10px;
    border: 1px solid #3c3a4f;
    box-shadow: 0px 0px 20px 5px #3c3a4f;
  }

  .game-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .title-status {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .title-status h3 {
    font-family: "Orbitron", sans-serif;
    font-weight: 400;
    color: #ffffff;
  }

  .actions {
    display: flex;
    gap: 0.5rem;
  }

  .status-select {
    background: #2d3346;
    border: 1px solid #3d4355;
    padding: 0.7rem 1.2rem;
    border-radius: 12px;
    color: #e0e0e0;
    font-size: 1rem;
    cursor: pointer;
  }

  .save-btn {
    background: #00b4d7;
    border: none;
    padding: 0.6rem;
    border-radius: 12px;
    cursor: pointer;
    color: #fff;
    font-size: 1.2rem;
    transition: all 0.5s linear;
  }

  .save-btn:hover {
    background-color: #00829c;
    cursor: pointer;
  }

  .delete-btn {
    background-color: transparent;
    border: 2px solid #ff4c4c;
    padding: 0.6rem;
    border-radius: 12px;
    cursor: pointer;
    color: #ff4c4c;
    font-size: 1.2rem;
    transition: all 0.5s linear;
  }

  .delete-btn:hover {
    background: rgba(255, 0, 0, 0.1);
    cursor: pointer;
  }

  .rating-genres {
    display: flex;
    justify-content: space-between;
  }

  .rating-genres p:first-child {
    color: #ffffff;
  }

  .fa-star {
    color: #00b4d7;
  }

  .rating-genres p:last-child {
    color: #a7969c;
  }

  @media screen and (min-width: 1024px) {
    .wishlist-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
  }
</style>

<script>
  let isLoggedIn = false;
  let favorites: any[] = [];

  // Check Login
  async function checkLogin() {
    try {
      const res = await fetch("http://localhost:3500/users/check-auth", {
        credentials: "include",
      });

      if (res.ok) {
        isLoggedIn = true;
      }
    } catch (err) {
      console.error(err);
    }
  }

  // Load Fave
  async function loadFave() {
    if (!isLoggedIn) return;
    const res = await fetch("http://localhost:3500/games/favorites/list", {
      credentials: "include",
    });
    const data = await res.json();
    favorites = data.favorites;
    renderFave();
  }

  // Render Fave
  function renderFave() {
    const wishList = document.querySelector(".wishlist-list") as HTMLDivElement;
    wishList.innerHTML = "";

    if (favorites.length === 0) {
      wishList.innerHTML = `
        <p class="empty">Your wishlist is empty.</p>
      `;
      return;
    }

    favorites.forEach((g: any) => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = g.gameId;
      card.innerHTML = `
            <div class="game-img">
                <img src="${g.image}" alt="${g.title}" />
            </div>
        </div>

        <div class="game-info">
            <div class="title-status">
                <h3>${g.title}</h3>
                <div class="actions">
                    <select class="status-select" data-id="${g.gameId}">
                        <option value="Wishlist" ${g.status === "Wishlist" ? "selected" : ""}>Wishlist</option>
                        <option value="Playing" ${g.status === "Playing" ? "selected" : ""}>Playing</option>
                        <option value="Completed" ${g.status === "Completed" ? "selected" : ""}>Completed</option>
                    </select>

                    <button class="save-btn" data-id="${g.gameId}">
                        <i class="fa-solid fa-check"></i>
                    </button>

                    <button class="delete-btn" data-id="${g.gameId}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="rating-genres">
                <p><i class="fa-solid fa-star"></i> ${g.rating}</p>
                <p>${g.genres.map((x: any) => x.name).join(" | ")}</p>
            </div>
        </div>
    `;
      wishList.appendChild(card);
    });
  }

  // Handle delete
  document.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;
    const delBtn = target.closest(".delete-btn") as HTMLButtonElement;
    if (!delBtn) return;

    const gameId = delBtn.dataset.id;

    const fave = favorites.find((f) => f.gameId == gameId);
    if (!fave) return;

    await fetch(`http://localhost:3500/games/favorites/${fave.id}`, {
      method: "DELETE",
      credentials: "include",
    });

    await loadFave();
  });

  // Handle save
  document.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;
    const saveBtn = target.closest(".save-btn") as HTMLButtonElement;
    if (!saveBtn) return;

    const gameId = saveBtn.dataset.id;

    const fave = favorites.find((f) => f.gameId == gameId);
    const statusSelect = document.querySelector(
      `select[data-id="${gameId}"]`
    ) as HTMLSelectElement;
    const status = statusSelect.value;

    await fetch(`http://localhost:3500/games/favorites/${fave.id}`, {
      method: "PUT",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status }),
    });

    await loadFave();
  });

  // Card events
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;

    if (target.closest(".delete-btn")) return;
    if (target.closest(".save-btn")) return;

    if (target.closest(".status-select")) return;

    const card = target.closest(".card") as HTMLDivElement;
    if (!card) return;

    const id = card.dataset.id;
    if (!id) return;

    window.location.href = `/gamedetail?id=${id}`;
  });

  await checkLogin();
  await loadFave();
</script>
